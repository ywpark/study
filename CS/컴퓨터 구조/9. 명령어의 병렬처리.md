# 명령어의 병렬처리

---

## 1. 명령어 파이프라인 (Instruction Pipeline)

- CPU의 성능을 향상시키기 위해 명령어 처리를 여러 단계로 나누어 동시에 실행하는 명령어
병렬 처리 기법
- 4단계의 명령어 처리 과정
    - 명령어 인출 (Instruction Fetch)
        - 다음 명령어를 기억장치로부터 인출
    - 명령어 해석 (Instruction Decode)
        - 디코더(Decoder)를 이용해 명령어 해석
    - 명령어 실행 (Execute Instruction)
        - 해석된 명령어에 따라 데이터 연산을 수행
    - 결과 저장 (Write Back)
        - 명령어대로 처리된 데이터를 메모리에 기록
    
    > 💡
    > 
    > CPU의 명령어 처리는 인출(Fetch) ↔ 실행(Execution) 의 2단계로 알고 있는데 위에서 
    > 말한 4단계로 변경된 것인가?
    > 
    > `기본 CPU의 명령어 처리는 2단계가 맞다`.  2단계만 가지고는 `fetch 단계` `execution > 단계`의 실행 속도 차이에 따른 파이프라인의 효율저하를 해결하고자 4단계로 세분화 
    > 처리한 것이다.
    
- 같은 단계가 겹치지만 않는다면 CPU는 동시에 실행
- `파이프라인 위험 (Pipeline Hazard)`
    - 파이프라인 기법을 사용하는데 있어서 발생할 수 있는 문제점
    - `데이터 위험 (Data Hazard)`
        - 명령어 간의 의존성에 의해 발생
        - 이전 명령어를 끝까지 실행해야만 비로소 실행 할 수 있음
        
        ```
        명령어1 : R1 ← R2 + R3
        명령어2 : R4 ← R1 * R2
        
        # 명령어 파이프라인 1
        명령어1 : 인출|해석|실행|저장 
        명령어2 :      인출|해석|실행|저장
        
        위와 같은 경우 결과값이 다르게 나올 수 있음.
        
        # 명령어 파이프라인 2
        명령어1 : 인출|해석|실행|저장 
        명령어2 :     지연          |인출|해석|실행|저장
        
        그렇기에 2번과 같은 지연 발생
        ```
        
    - `제어 위험 (Control Hazard)`
        - 프로그램 카운터의 갑작스러운 변화에 의해 발생
        - 이러한 상황 방지하기 위한 기술이 `분기예측 (Branch Prediction)`
        
        ```
        # 명령어 파이프라인 
        명령어1 : 인출|해석|실행|저장 
        명령어2 :      인출|해석|실행|저장
        명령어3 :          인출|해석|실행|저장
        
        명령어1 에서 분기를 하게되면 명령어2~3은 지연 발생
        ```
        
    - `구조적 위험 (Structural Hazard)`
        - 서로 다른 명령어가 같은 자원에 접근할 때 발생
        
        ```
        # 명령어 파이프라인 1
        명령어1 : 인출|해석|실행|데이터인출|저장 
        명령어2 :      인출|해석|실행|저장
        
        # 데이터인출 : Load 명령어의 경우 데이터를 인출하기 위해 메모리에 접근하는 단계
        
        명령어1 과 명령어2 가 동시에 저장 단계를 진행하는 상황이 발생하기 때문에
        지연 발생
        
        # 명령어 파이프라인 2
        명령어1 : 인출|해석|실행|데이터인출|저장 
        명령어2 :      인출|해석|실행|지연|저장
        ```
        

## 2. 슈퍼스칼라 (Superscalar)

- CPU 내부에 여러 개의 명령어 파이프라인을 포함한 구조
- 현재의 멀티스레드 프로세서
- 이론적으로 파이프라인 개수에 비례하여 CPU의 처리 속도는 증가하지만, 그만큼 파이프라인 위험도 증가하기 때문에 개수에 비례하여 처리 속도가 증가 안함

## 3. 비순차적 명령어 처리 (Out-of-Order Execution, OoOE)

- 명령어는 보통 순서대로 실행되지만, 데이터 의존성 없는 명령어는 순서를 바꿔서 먼저 실행
- 파이프라인 효율을 높임